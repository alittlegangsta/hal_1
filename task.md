# 任务：

我现在要完成一个任务：

在测井中，利用已有的超声测井数据（即已知井的哪些部位发生窜槽），根据该数据来分析声波测井的测井声波的哪些成分或者是哪些时域或者频域的特征对流体成分敏感（即窜槽）。要求方法不需要太复杂，简单即可。并且要求提取特征的过程是可逆的，即当我最终识别到是什么特征对窜槽敏感后，当我有了新的声波信号数据，我可以通过该特征重新识别到是新的声波信号的哪些波对窜槽敏感。要求使用机器学习或者深度学习相关的ai方法。

已知在超声测井数据中，有深度点数据Depth，以及对应每一个深度点和方位角所接收到的值Zc，值的幅值越大代表胶结程度越好，幅值越小代表胶结程度越差，发生窜槽。

对于声波测井数据，有深度点数据Depth，以及对应每一个深度点、每一个时间点和每一个方位接收器的声波幅值。

---

# 需注意：

- 深度：在超声数据与声波数据深度对齐的情况下，对于声波数据，是以第7个阵列接收器所在的深度为深度基准点，并且阵列接收器是按编号由小到大按深度递减的方向排列。声源在第一个阵列接收器下方1feat处。根据基准接收器（第7个）的深度，计算每个接收器的实际深度。例如，接收器i的实际深度为基准深度 + (7 - i) × 0.5feat。

- 阵列接收器之间间距0.5feat

- 高通滤波：对于XSILMR声波数据，滤掉低于1000Hz的波，参考以下matlab代码：
  % High-pass filter
  
  dt=1e-5
  
  Fcut = 1000;
  
  Fs = 1/dt;
  
  [b,a] = butter(4,Fcut/(Fs/2),'high');

---

# # 数据信息：

超声：具有很强的指向性，即是单发射源垂直于井筒，发射后再原路返回接收，每隔2度旋转发收一次，所以共180个方位角，总共360度。并且深度对应准确，深度分辨率高。

声波：就算每个阵列接收器都有8个方位接收器，但还是受所有方位的影响，由于是阵列接收器，且以第7个接收器为深度基准，每个接收器相隔0.5feat。

1. ## XSILMR：

### 总体信息：

- data/raw/XSILMR文件夹下有13个.mat文件，为XSILMR01.mat-XSILMR13.mat，如“data/raw/XSILMR/XSILMR01.mat“

- 13个.mat文件分别一一对应13个阵列接收器。从1到13阵列接收器，沿轴向等间隔0.5feat排列，从1至13阵列接收器离单极子发射源越远，深度越浅。发射源在第一个阵列接收器下方1ft处

- 每一个阵列接收器都有8个方位接收器A-H，等深度点沿圆周方向360度等角度排列，每45度一个方位接收器。A正对0度，B正对45度，以此类推。

- 因此共有13*8=104个接收器

- 阵列接收器以第7个阵列接收器所在深度为深度基准点。即例如在.mat文件中，第7个阵列接收器所在的深度为1000ft,则第6个阵列接收器所在深度为1000.5ft，而第8个阵列接收器所在深度为999.5ft。即举个例子，如果某处数据深度点所对应的深度值为3000feat，那么第3个阵列接收器所反映的即是2996-2998feat深度的信息的声波，第7个接收器所接收的是反映2996-3000feat深度的信息的声波。

- 数据结构是结构体

### 详细信息：

- 每一个.mat文件都是1*1大小，是struct类，以XSILRM04.mat举例，属性如下：
  
  | 参数名称           | 类型               | 值   |
  | -------------- | ---------------- | --- |
  | Depth          | 1×7108 double    | -   |
  | ACQ            | 1×7108 uint16    | -   |
  | Tad            | -                | 10  |
  | WaveRng04SideA | 1024×7108 double | -   |
  | WaveRng04SideB | 1024×7108 double | -   |
  | WaveRng04SideC | 1024×7108 double | -   |
  | WaveRng04SideD | 1024×7108 double | -   |
  | WaveRng04SideE | 1024×7108 double | -   |
  | WaveRng04SideF | 1024×7108 double | -   |
  | WaveRng04SideG | 1024×7108 double | -   |
  | WaveRng04SideH | 1024×7108 double | -   |
  
  - Depth:共7108个深度点，值范围：[2350.75678568363,5759.53416620890]，我需要对应深度值为2732-4132feat的对应的深度点范围，每个深度点之间相差0.48feat左右，深度由深至浅，平均深度间隔：-0.4796英尺（负值表示递减）
  
  - WaveRng04SideA-WaveRngSideH，共8个方位接收器，每一个接收器所存储的值是1024*7108的double值，横轴1024是时间长度，时间间隔10us，纵轴7108是深度点，每一个double值是该时间点和深度点对应的声波振幅。

---

2. ## CAST:

### 总体信息：

- 路径为“data/raw/CAST.mat”
- 数据结构是结构体

### 详细信息：

- 该.mat文件为1*1大小，struct类，属性如下：
  
  | 参数名称  | 类型               | 值   |
  | ----- | ---------------- | --- |
  | Depth | 1×24750 double   | -   |
  | Zc    | 180×24750 single | -   |
  
  - Depth：共24750个深度点，值范围：[2395.44500001669,5804.33666668336]，我需要对应深度值为2732-4132feat的对应的深度点范围，每个深度点之间相差0.14feat左右，深度由深至浅。
  
  - Zc：值是180×24750 为single类型。180对应角度点，共360度，即每个角度点相隔2度。24750是深度点，与Depth相对应。Zc每一个值对应该方位角和深度点的幅度值，幅度值越高代表胶结程度越好，没有窜槽发生，幅度值越低代表胶结程度越差，发生窜槽。从超声结果来看，可以视作以2.5为阈值，低于2.5的视为发生窜槽，高于2.5的则视为胶结良好

---

# **项目最终解决方案（AI Agent执行指南）**

#### **I. 项目核心目标**

利用高分辨率的超声测井数据（CAST）作为地面实况（Ground Truth），通过AI模型分析低分辨率的阵列声波测井数据（XSILMR），精准识别出对水泥胶结窜槽现象最敏感的声波时频特征。该方法必须具备可逆性，能够将识别出的特征应用于新数据的解释。

#### **II. 核心方法论 (升级)**

1. **高级阵列处理原则**：不再将原始或简单滤波后的波形直接用于分析，而是首先应用**阵列信号处理技术**（如慢度时间相干分析）来提取物理意义明确的差分特征（如局部慢度、衰减率）并生成高信噪比的波形。
2. **局部化分析原则**：所有从阵列处理中提取的特征和生成的波形，都将精确地对应到阵列中每个接收器的**局部深度**位置。
3. **混合特征与回归原则**：构建一个混合输入AI模型，该模型同时接收：
   - 经过阵列处理后得到的“干净”波形的**时频图像**。
   - 通过阵列差分测量计算出的一系列**物理特征向量**。
   - 最终目标是**回归预测**出由高分辨率超声数据定义的“窜槽比例”。

---

#### **III. 详细实施步骤与方法**

##### **阶段一：数据准备与物理对齐**

- **功能**：加载所有数据，并建立起XSILMR和CAST数据在三维物理空间中的精确对应关系。
- **使用方法**：
  1. **数据加载**：使用能解析`.mat`文件的库（如Python中的`scipy.io.loadmat`）加载全部13个`XSILMR##.mat`文件和`CAST.mat`文件。
  2. **绝对深度计算**：对XSILMR数据进行逐行处理。必须实现一个函数，根据该行中第7个接收器的深度基准值，应用公式 `D_actual(i) = D_base + (7 - i) × 0.5 ft`，计算出该时刻**全部13个接收器**各自的绝对物理深度。这是后续所有局部化分析的基础。
  3. **深度区间筛选**：使用计算出的绝对深度，对XSILMR数据集进行筛选。同时，对CAST数据集也进行筛选，仅保留深度在**2732英尺至4132英尺**之间的数据。

##### **阶段二：高级阵列特征工程 (核心升级)**

- **功能**：从原始的阵列波形数据中，提取出经过物理原理验证的、信息含量极高的特征集。

- **使用方法**：
  
  1. **高通滤波 (不变)**：对数据集中所有原始波形应用1000Hz的4阶巴特沃斯高通滤波器。
  
  2. **慢度-时间相干性分析 (新增核心步骤)**：
     
     - **方法**：实现或调用一个**慢度-时间相干（Slowness-Time Coherence, STC）**处理算法。
     - **过程**：使用一个包含多个接收器（例如5或7个）的**滑动窗口**，沿整个接收器阵列进行移动。在每一个深度位置（即窗口中心位置），STC算法会生成一个二维的相干图谱，其坐标轴为“慢度”和“时间”。
     - **产出1 - 局部慢度特征**：在每个深度的相干图谱上，自动拾取与“套管波”到达时间对应的相干能量团的慢度值。这将为每个接收器 `i` 生成一个**局部慢度 `s_i`**。这是非常有价值的物理特征。
     - **产出2 - 相干滤波后的波形**：利用STC分析的结果，可以对原始波形进行滤波，仅保留那些与检测到的相干波（如套管波）路径一致的信号成分，从而极大地压制非相干噪声和其它模式的干扰。这将为每个接收器 `i` 生成一条信噪比极高的**“干净”波形 `W'_i`**。这就是我们之前所说的“基于时差校正的局部叠加”的高级实现。
  
  3. **生成图像特征 `X_image` (基于新波形)**：
     
     - 对上一步产出的**每一条“干净”波形 `W'_i`**，应用**连续小波变换（CWT）**，生成其二维尺度图。
  
  4. **生成数值特征向量 `X_vector` (更丰富)**：
     
     - **主要物理特征**：
       - **局部慢度 `s_i`**：直接使用步骤2中计算出的结果。
       - **局部衰减率 `α_i`**：使用“干净”波形 `W'`，通过公式 `α_i = log( W'_{i-1}的幅值 / W'_{i}的幅值 ) / Δz` 计算相邻接收器间的幅度衰减率。这是一个直接反映胶结质量的强特征。
     - **其他辅助特征**：对“干净”波形 `W'_i` 计算其最大绝对幅值、RMS幅值等，作为补充信息。
     - 将以上所有计算出的数值（`s_i`, `α_i` 等）合并成一个一维向量。

##### **阶段三：高分辨率标签生成 (生成目标Y)**

- **功能**：利用高分辨率的CAST数据，为**每一条**独立的声波波形（及其对应的特征集）生成一个精确的、量化的回归目标值。
- **使用方法**：
  1. **定义方位扇区**：建立一个从XSILMR的8个方位接收器（A-H）到具体角度范围的映射。采用`45度`扇区划分策略（例如，方位A对应`[-22.5°, +22.5°]`，方位B对应`[22.5°, 67.5°]`等）。
  2. **计算“窜槽比例”标签**：遍历每一条声波波形，执行以下精确计算： a. 获取该波形的绝对深度 `D_actual`和其对应的方位扇区 `Azimuth_Sector`。 b. 定义其三维目标区域：深度窗口为 `[D_actual - 0.25 ft, D_actual + 0.25 ft]`，方位窗口为`Azimuth_Sector`。 c. 在此三维区域内，查询并统计出所有CAST数据点的总数 `N_total`。 d. 在这些点中，统计出满足 `Zc < 2.5` 条件的数据点数量 `N_channeling`。 e. 最终的回归标签 **`Y = N_channeling / N_total`**。这是一个介于0和1之间的浮点数。

##### **阶段四：AI模型架构与训练**

- **功能**：构建并训练一个混合输入模型，使其能够从声波特征准确预测“窜槽比例”。
- **使用方法**：
  1. **模型架构（混合输入）**：
     - **图像处理分支**：搭建一个**2D卷积神经网络（CNN）**，接收尺度图（`X_image`）作为输入。该分支应包含若干个`Conv2D`层和`MaxPooling2D`层，最后通过`Flatten`层输出一个一维特征向量。
     - **数值处理分支**：一个简单的输入层，接收一维的手动特征向量（`X_vector`）。
     - **特征融合**：使用**Concatenate（拼接）**层，将CNN分支输出的向量和数值特征向量合并成一个更长的、信息更丰富的向量。
     - **预测头**：将拼接后的向量送入一个或多个**Dense（全连接）**层进行最终的信息整合。最后一层必须是**只有一个神经元**的Dense层，并使用 **Sigmoid** 激活函数，以确保模型输出值在[0, 1]范围内。
  2. **模型训练配置**：
     - **任务类型**：**回归（Regression）**。
     - **损失函数**：选用**均方误差（Mean Squared Error, MSE）**。
     - **优化器**：选用鲁棒性强的**Adam**优化器。
     - **训练流程**：将数据集划分为训练集和验证集，训练模型以最小化训练集上的MSE损失，同时监控验证集上的损失以避免过拟合。

##### **阶段五：模型解释与可逆应用**

- **功能**：分析训练好的模型，找出其决策依据（敏感特征），并建立一套可应用于新数据的标准流程。
- **使用方法**：
  1. **敏感特征可视化**：对训练好的模型，主要针对其**CNN分支**，应用**Grad-CAM（梯度加权类激活映射）**技术。
  2. **特征解释**：将模型判断为高“窜槽比例”的样本输入Grad-CAM。该技术会生成一张“热力图”，当它叠加在输入的尺度图上时，高亮区域即代表模型做出决策时重点关注的时频区域。通过观察大量样本，找到被持续高亮的、有规律的区域，这些区域就是我们要找的“敏感特征”。
  3. **新数据应用流程（可逆性实现）**： a. 对任何一条新的声波波形，必须经过与**阶段二完全相同**的特征工程流程，得到其尺度图和数值特征向量。 b. 将特征送入训练好的混合模型，得到一个预测的“窜槽比例”值。 c. 同时，将该波形的尺度图送入Grad-CAM，生成对应的热力图，从而在视觉上清晰地指明，是波形中的哪个具体部分（什么时间到达、什么频率成分）对当前的窜槽预测贡献最大。
